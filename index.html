<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>PeaceRep</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.js"></script>
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="css/index.css">
    <link rel="icon" type="image/png" href="img/peace.png">
    <script src="js/d3.js" type="text/javascript"></script>
    <script src="js/countries.js"></script>
</head>

<body>
    <div id="header">
        <img id="title_img" src="img/logo.png" alt="PeaceRep Logo" />
        <img id="local_img" src="img/local.svg" alt="PeaceRep Local Logo" />
        <h1 id="big_title">PA-X Local Agreements</h1>
        <button id="refresh_button"><i class="fa fa-refresh" style="color:black"></i></button>
        <button title="Information" id="info_button"><i class="fa fa-info"></i></button>
    </div>

    <div id="info">
        <div id="info_title_div">
            <h3>Information</h3>
        </div>
        <div id="info_content">
            This database lists all agreements included on the main PA-X database that deal in some way with local
            issues,
            involve local actors, and deal with forms of local/communal violent conflict. Agreements span the 1990 to
            2023,
            with global coverage, forming a collection of 344 local agreements, 12 of which are new in this release of
            PA-X
            Local. PA-X Local only includes agreements for which we could obtain a text, and is therefore neither
            exhaustive
            of all local negotiation practices, nor clearly representative of them, nor of the range of armed actors and
            groups involved in local agreement-making. While it is likely to therefore reflect some processes more than
            others, it forms a useful qualitative tool for beginning to understand local processes and is the only
            database
            that we know of to currently do this.
            </br>
            </br>
            If you are interested in how we selected documents and made decisions on coding,
            see our <a id="first_link" target="_blank"
                href="https://www.peaceagreements.org/files/About%20PA-X%20Local%20-%20final%20(6).pdf">About PA-X
                Local</a>
            document (also available in <a id="first_link" target="_blank"
                href="https://www.peaceagreements.org/files/About%20PA-X%20Local%20-%20Ar%20(1)%20(2).pdf">Arabic</a>
            and <a id="first_link" target="_blank"
                href="https://www.peaceagreements.org/files/About%20PA-X%20Local%20-%20FR%20(3).pdf">French</a>).
            </br>
            </br>
            See also the <a id="first_link" target="_blank"
                href="https://www.peaceagreements.org/files/Glossary_PA-X_Local.pdf">local agreements
                glossary/definitions</a>,
            <a id="first_link" target="_blank"
                href="https://www.peaceagreements.org/files/PA-X%20Local%20Codebook%20Version%204%20(2023).pdf">codebook</a>,
            and
            <a id="first_link" target="_blank"
                href="https://www.peaceagreements.org/files/Terms_of_Use_updated_added_local.pdf">terms of use</a>.

        </div>
    </div>

    <div id="map"></div>

    <div id="description">
    </div>

    <div id="peace_process">
        <h3 id="peace_title"></h3>
        <div id="peace_title_div" class="third">
            <div id="process_stage"></div>
            <div id="locale"></div>
            <div id="agreement"></div>
            <div id="desc"></div>
        </div>
        <div id="timeline" class="third">
            <h5 id="time_title" style="margin-left: 10px;">Timeline: </h5>
        </div>
        <div id="links">
            <div class="box" id="box1">
                <div id="krava">
                    <a id="linkie" target="_blank" href=""><img src="img/agt_icon.svg" id="first_img"
                            alt="HTML tutorial"></a>
                    <p id="img_text">View PDF</p>
                </div>
            </div>
            <div class="box" id="box2">
                <div id="krava">
                    <a id="linkie1" target="_blank" href=""><img src="img/peace_circle.svg" id="second_img"
                            alt="HTML tutorial"></a>
                    <p id="img_text">PA-X</p>
                </div>
            </div>
            <div class="box" id="box3">
                <div id="krava">
                    <a id="linkie2" target="_blank" href=""><img src="img/local.svg" id="third_img"
                            alt="HTML tutorial"></a>
                    <p id="img_text">PA-X Local</p>
                </div>
            </div>
            <div class="box" id="box4">
                <div id="krava">
                    <a id="linkie3" target="_blank" href=""><img src="img/search.svg" id="four_img"
                            alt="HTML tutorial"></a>
                    <p id="img_text">Local Search</p>
                </div>
            </div>
        </div>
    </div>

    <div id="net-legend" class="legend">
        <h4 id="filter_title">Filter by Stages</h4>
        <div id="one"><span style="background-color: #fbb03b; cursor: pointer;"></span>Pre-negotiation</div>
        <div id="three"><span style="background-color: #e55e5e; cursor: pointer;"></span>Ceasefire</div>
        <div id="four"><span style="background-color: #3bb2d0; cursor: pointer;"></span>Framework-substantive, partial
        </div>
        <div id="five"><span style="background-color: steelblue; cursor: pointer;"></span>Implementation</div>
        <div id="two"><span style="background-color: #223b53; cursor: pointer;"></span>Renewal</div>
        <div id="six"><span style="background-color: white; cursor: pointer;"></span>Other</div>
    </div>

    <script>
        //adapt to screen
        let screen_height = window.innerHeight;
        let screen_width = window.innerWidth;
        let details_height = screen_height - 50;

        const margin = { top: 10, right: 20, bottom: 30, left: 25 },
            width = screen_width * 0.28 - margin.left - margin.right,
            height = (details_height - 30) * 0.45 - margin.top - margin.bottom;

        // append the svg
        const svg = d3.select("#timeline")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        svg.append("g")
            .attr("class", "myXaxis")
        svg.append("g")
            .attr("class", "myYaxis")

        const x_scale = d3.scaleTime()
            .range([0, width])

        const y = d3.scaleLinear()
            .domain([0, 5])
            .range([height, 0]);

        let simulation = d3.forceSimulation()
            .force("x", d3.forceX(function (d) { return x_scale(d[1][0][0]); }).strength(3))
            .force("y", d3.forceY(height / 2))
            .force("collide", d3.forceCollide(8))
            .stop();

        d3.select("#info_content").style("height", details_height - 90 + "px")
        d3.selectAll("#peace_process, #info")
            .style("height", details_height + "px")
            .style("width", screen_width * 0.28 + "px")
            .style("right", - screen_width * 0.30 + "px")

        d3.selectAll(".third")
            .style("height", (details_height - 16) * 0.45 + "px")
        d3.select("#links")
            .style("height", (details_height - 16) * 0.1 + "px")

        const stable_height = (details_height - 16) * 0.45;
        // info button
        let counter_collab = 0;
        d3.select("#info_button").on("click", function () {
            counter_collab += 1;
            d3.selectAll("#peace_process")
                .transition().duration(800)
                .style("right", - screen_width * 0.30 + "px")
            if (counter_collab % 2 !== 0) {
                d3.select("#info")
                    .transition().duration(500)
                    .style("right", 5 + "px")
            }
            else {
                d3.select("#info")
                    .transition().duration(500)
                    .style("right", - screen_width * 0.30 + "px")
            }
        })
        // load mapbox
        mapboxgl.accessToken = 'pk.eyJ1Ijoic2FzaGFnYXJpYmFsZHkiLCJhIjoiY2xyajRlczBlMDhqMTJpcXF3dHJhdTVsNyJ9.P_6mX_qbcbxLDS1o_SxpFg';
        const map = new mapboxgl.Map({
            container: 'map',
            // style: 'mapbox://styles/mapbox/dark-v11',
            style: 'mapbox://styles/sashagaribaldy/cls4l3gpq003k01r0fc2s04tv',
            center: [40.137343, 25.137451],
            zoom: 3,
            attributionControl: false
        });

        $('#box1').click(function () {
            window.open($(this).find('a:first').attr('href'));
            return false;
        });
        $('#box2').click(function () {
            window.open($(this).find('a:first').attr('href'));
            return false;
        });
        $('#box3').click(function () {
            window.open($(this).find('a:first').attr('href'));
            return false;
        });
        $('#box4').click(function () {
            window.open($(this).find('a:first').attr('href'));
            return false;
        });

        // load the data
        Promise.all([
            d3.csv("data/local.csv"),
            d3.csv("data/loc_correction.csv"),
            d3.csv("data/pax.csv"),
            d3.csv("data/links.csv"),
        ]).then(function (files) {
            //clean location names and add description
            let raw_data = files[0]
            let parseDate = d3.timeParse("%d-%m-%Y");
            raw_data.forEach(function (o) {
                o.date = o.Dat.replace(/\//g, '-')
                o.date = parseDate(o.date)
            })
            function find_id(curr_id) {
                let the_country = files[1].find(function (x) {
                    return x.AgtId == curr_id
                })
                let the_category = files[2].find(function (x) {
                    return x.AgtId == curr_id
                })
                let the_link = files[3].find(function (x) {
                    return x.AgtId == curr_id
                })
                return [the_country.country_entity, the_category, the_link]
            }
            raw_data.forEach(function (d) {
                let curr_id = d.AgtId;
                let the_country = find_id(curr_id)
                // console.log(the_country);
                d.Con = the_country[0];
                d.stage = the_country[1].stage_label;
                d.description = the_country[1].description;
                d.agreement = the_country[1].Agt;
                d.linkie = the_country[1].PDF_Hyperlink
                d.linkie1 = the_country[1].PAX_Hyperlink
                d.linkie2 = the_country[2].PAX_Local_Hyperlink
                d.linkie3 = the_country[2].local_search
            })
            //construct unique country array
            let country_array = []
            raw_data.forEach((d) => {
                if (country_array.includes(d.Con) == false) {
                    country_array.push(d.Con)
                }
            })
            // creating conflict geojson
            let local_conflict_geojson = []
            raw_data.forEach(function (d) {
                let to_push = {
                    'type': 'Feature',
                    'properties': {
                        'id': d.AgtId,
                        'p_process': d.PPName,
                        'text': d.LocaleName,
                        'stage': d.stage,
                        'description': d.description,
                        'agreement': d.agreement,
                        'datum': d.Dat,
                        'link': d.linkie,
                        'link1': d.linkie1,
                        'link2': d.linkie2,
                        'link3': d.linkie3
                    },
                    'geometry': {
                        'type': 'Point',
                        'coordinates': [d.LongDec, d.LatDec]
                    }
                }
                local_conflict_geojson.push(to_push)
            })
            const thaa = {
                'type': 'FeatureCollection',
                'features': local_conflict_geojson
            };
            let hoveredPolygonId = null;
            //draw polygons
            map.on('load', () => {
                // Add a data source containing GeoJSON data.
                map.addSource('states', {
                    'type': 'geojson',
                    'data': thaa,
                    'generateId': true //This ensures that all features have unique IDs
                });
                //circles for agreements
                map.addLayer(
                    {
                        'id': 'population',
                        'type': 'circle',
                        'source': 'states',
                        'paint': {
                            "circle-opacity": 0.7,
                            "circle-stroke-width": 2,
                            'circle-radius': 7,
                            "circle-stroke-color":
                                [
                                    'case',
                                    ['boolean', ['feature-state', 'click'], false],
                                    'white',
                                    'black'
                                ],
                            'circle-color':
                                [
                                    'match',
                                    ['get', 'stage'],
                                    'Pre-negotiation',
                                    '#fbb03b',
                                    'Renewal',
                                    '#223b53',
                                    'Ceasefire',
                                    '#e55e5e',
                                    'Framework-substantive, partial',
                                    '#3bb2d0',
                                    'Implementation',
                                    'steelblue',
                                    'Other',
                                    'white',
                                    'white'
                                ]
                        }
                    },
                    // Place polygons under labels, roads and buildings.
                    // 'aeroway-polygon'
                );

                map.on('click', 'population', (e, i) => {
                    if (e.features.length > 0) {
                        if (hoveredPolygonId !== null) {
                            map.setFeatureState(
                                { source: 'states', id: hoveredPolygonId },
                                { click: false }
                            );
                        }
                        hoveredPolygonId = e.features[0].id;
                        map.setFeatureState(
                            { source: 'states', id: hoveredPolygonId },
                            { click: true }
                        );
                    }
                    d3.select("#description")
                        .style("display", "none")
                    map.flyTo({ center: [e.lngLat.lng, e.lngLat.lat], zoom: 6 });
                    const description = e.features[0].properties
                    d3.select("#peace_process")
                        .transition().duration(800)
                        .style("right", 3 + "px")
                    d3.select("#info")
                        .transition().duration(500)
                        .style("right", - screen_width * 0.30 + "px")
                    counter_collab = 0;

                    d3.select("#peace_title")
                        .html(description.p_process)
                    d3.select("#process_stage")
                        .html(`<h5>Stage of Process: </h5>` + `<p>` + description.stage + `</p>`)
                    d3.select("#agreement")
                        .html(`<h5>Agreement: </h5>` + `<p>` + description.agreement + ` (` + description.datum + `)` + `</p>`)
                    d3.select("#locale")
                        .html(`<h5>Locale: </h5>` + `<p>` + description.text + `</p>`)
                    d3.select("#desc")
                        .html(`<h5>Description: </h5>` + `<p>` + description.description + `</p>`)

                    $("#linkie").attr('href', description.link);
                    $("#linkie1").attr('href', description.link1);
                    $("#linkie2").attr('href', description.link2);
                    $("#linkie3").attr('href', description.link3);

                    let reduce_height = $("#peace_title").height() + 21;
                    let img_height = $(".box").height() - 30;
                    d3.select("#peace_title_div").style("height", stable_height - reduce_height + "px")
                    d3.selectAll("#first_img, #second_img, #third_img, #four_img")
                        .style("height", img_height + "px")
                    d3.selectAll("#krava")
                        .style("top", 10 + "px")

                    //timeline
                    let peace_instance = d3.groups(raw_data, function (r) {
                        return r.PPName == description.p_process
                    })
                    let true_data;
                    if (peace_instance[0][0] == true) {
                        true_data = peace_instance[0][1]
                    }
                    else {
                        true_data = peace_instance[1][1]
                    }
                    let peace_data = true_data;
                    function sortByDateAscending(a, b) {
                        return a.date - b.date;
                    }
                    let the_data = peace_data.sort(sortByDateAscending);
                    let year_division = d3.groups(the_data, d => d.AgtId, d => d.date)
                    x_scale.domain(d3.extent(year_division, function (d) { return d[1][0][0]; }))
                        .nice();
                    simulation.nodes(year_division)
                    simulation.alpha(1).restart().tick();
                    for (var i = 0; i < 200; ++i) { simulation.tick(); }
                    const delaunay = d3.Delaunay.from(year_division, d => d.x, d => d.y),
                        voronoi = delaunay.voronoi([0, 0, width, height]);
                    //drawing x axis
                    svg.selectAll(".myXaxis").transition().duration(500)
                        .attr("transform", "translate(0," + height + ")")
                        .call(d3.axisBottom(x_scale).tickFormat(d3.timeFormat("%Y")).tickSize(-height).ticks(5))
                        .style("stroke-dasharray", "5 5")
                        .selectAll("text")
                        .attr("transform", "translate(0,-4)")
                        .style("fill", "white")
                        .style("text-anchor", "middle")
                        .style("font-size", "12px")
                        .style("font-family", "Montserrat");

                    svg.selectAll('.my_circles')
                        .data(year_division)
                        .join('circle')
                        .attr('cx', d => d.x)
                        .attr('cy', d => d.y)
                        .attr("class", "my_circles")
                        .attr('r', function (d) {
                            return 7
                        })
                        .style('fill', function (d) {
                            let color_choice;
                            switch (d[1][0][1][0].stage) {
                                case "Pre-negotiation":
                                    color_choice = '#fbb03b';
                                    break;
                                case "Renewal":
                                    color_choice = '#223b53'
                                    break;
                                case "Ceasefire":
                                    color_choice = '#e55e5e'
                                    break;
                                case "Framework-substantive, partial":
                                    color_choice = '#3bb2d0'
                                    break;
                                case "Implementation":
                                    color_choice = 'steelblue'
                                    break;
                                case "Other":
                                    color_choice = 'white'
                                    break;
                                default:
                                    color_choice = 'white'
                            }
                            return color_choice
                        })
                        .style('stroke', function (d) {
                            if (d[1][0][1][0].AgtId == description.id) {
                                return "white"
                            }
                            else {
                                return "none"
                            }
                        })
                        .style('stroke-width', 2)

                    // svg.selectAll(".mybar")
                    //     .data(almost_final, d => d)
                    //     .join(
                    //         enter => enter.append("rect")
                    //             .attr("class", "mybar")
                    //             .attr("x", d => x_scale(d[0]))
                    //             .attr("y", the_height)
                    //             .attr("rx", 3)
                    //             .attr("height", 0)
                    //             .attr("width", 1)
                    //             .attr("fill", "white")
                    //             .transition().duration(1000)
                    //             .attr("y", function (d) {
                    //                 return y(d[1].length)
                    //             })
                    //             .attr("height", d => the_height - y(d[1].length))
                    //             .selection(),
                    //         update => update
                    //             .transition().duration(1000)
                    //             .attr("x", d => x_scale(d[0]))
                    //             .attr("y", function (d) {
                    //                 return y(d[1].length)
                    //             })
                    //             .attr("width", 1)
                    //             .attr("height", d => the_height - y(d[1].length))
                    //             .selection(),
                    //         exit => exit
                    //             .transition().duration(500)
                    //             .attr("y", the_height)
                    //             .attr("height", 0)
                    //             .remove()
                    //     )

                    d3.selectAll(".domain")
                        .attr("visibility", "hidden")
                })



                d3.select("#one").on("click", function (d) {
                    map.setFilter('population', ['==', 'stage', 'Pre-negotiation']);
                })
                d3.select("#two").on("click", function (d) {
                    map.setFilter('population', ['==', 'stage', 'Renewal']);
                })
                d3.select("#three").on("click", function (d) {
                    map.setFilter('population', ['==', 'stage', 'Ceasefire']);
                })
                d3.select("#four").on("click", function (d) {
                    map.setFilter('population', ['==', 'stage', 'Framework-substantive, partial']);
                })
                d3.select("#five").on("click", function (d) {
                    map.setFilter('population', ['==', 'stage', 'Implementation']);
                })
                d3.select("#six").on("click", function (d) {
                    map.setFilter('population', ['==', 'stage', 'Other']);
                })

                map.on('mousemove', 'population', (e) => {
                    map.getCanvas().style.cursor = 'pointer';
                    const description = e.features[0].properties
                    // if (e.features.length > 0) {
                    //     if (hoveredPolygonId !== null) {
                    //         map.setFeatureState(
                    //             { source: 'states', id: hoveredPolygonId },
                    //             { click: false }
                    //         );
                    //     }
                    //     hoveredPolygonId = e.features[0].id;
                    //     map.setFeatureState(
                    //         { source: 'states', id: hoveredPolygonId },
                    //         { click: true }
                    //     );
                    // }

                    d3.select("#description")
                        .style("display", "block")
                        .style("left", e.point.x + 30 + "px")
                        .style("top", e.point.y - 25 + "px")
                        .html(description.agreement)
                });

                // Change it back to a pointer when it leaves.
                map.on('mouseleave', 'population', () => {
                    map.getCanvas().style.cursor = '';
                    // if (hoveredPolygonId !== null) {
                    //     map.setFeatureState(
                    //         { source: 'states', id: hoveredPolygonId },
                    //         { hover: false }
                    //     );
                    // }
                    // hoveredPolygonId = null;
                    d3.select("#description")
                        .style("display", "none")
                });

                // refresh everything
                d3.select("#refresh_button").on("click", function (m) {
                    if (hoveredPolygonId !== null) {
                        map.setFeatureState(
                            { source: 'states', id: hoveredPolygonId },
                            { click: false }
                        );
                    }
                    hoveredPolygonId = null;
                    map.flyTo({ center: [40.137343, 25.137451], zoom: 3 });
                    // d3.select("#big_title").text("Conflict and Peace Process Map")
                    d3.selectAll("#peace_process, #info")
                        .transition().duration(800)
                        .style("right", - screen_width * 0.30 + "px")
                    counter_collab = 0;
                    map.setFilter('population', null)
                })

                // map.addSource('states', {
                //     'type': 'geojson',
                //     'data': geo_data,
                //     'generateId': true //This ensures that all features have unique IDs
                // });
                // Add a new layer to visualize the polygon.
                // map.addLayer({
                //     'id': 'state-fills',
                //     'type': 'fill',
                //     'source': 'states',
                //     'layout': {},
                //     'paint': {
                //         'fill-color': '#006297',
                //         'fill-opacity': 0.5
                //     },
                //     'filter': ['in', 'ADMIN', ...country_array]

                // });
                // map.addLayer({
                //     'id': 'outline',
                //     'type': 'line',
                //     'source': 'states',
                //     'layout': {},
                //     'paint': {
                //         'line-color': 'black',
                //         'line-width': [
                //             'case',
                //             ['boolean', ['feature-state', 'hover'], false],
                //             2,
                //             0.5
                //         ],
                //     }
                // });

                // for (const marker of raw_data) {
                //     if (marker.LongDec !== "999") {
                //         let coord = [marker.LongDec, marker.LatDec]
                //         const el = document.createElement('div');
                //         const width = 10;
                //         const height = 10;
                //         el.className = 'marker';
                //         el.style.backgroundImage = `url(img/circle.png)`;
                //         el.style.width = `${width}px`;
                //         el.style.height = `${height}px`;
                //         el.style.backgroundSize = '100%';
                //         el.style.cursor = "pointer"

                //         new mapboxgl.Marker(el)
                //             .setLngLat(coord)
                //             .addTo(map);
                //     }
                // }

            })


        });
    </script>
</body>

</html>