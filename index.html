<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>PeaceRep</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.js"></script>
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="css/index.css">
    <script src="js/d3.js" type="text/javascript"></script>
    <script src="js/countries.js"></script>
</head>

<body>
    <div id="header">
        <img id="title_img" src="img/logo.png" alt="PeaceRep Logo" />
        <h1 id="big_title">Local Peace Processes Map</h1>
        <button id="refresh_button"><i class="fa fa-refresh" style="color:black"></i></button>
        <button title="Information" id="info_button"><i class="fa fa-info"></i></button>
    </div>

    <div id="info">
        <div id="info_title_div">
            <h3>Information</h3>
        </div>
        <div id="info_content">
        </div>
    </div>

    <div id="map"></div>

    <div id="description"></div>

    <div id="peace_process">
        <div id="peace_title_div" class="third">
            <h3 id="peace_title"></h3>
            <div id="process_stage"></div>
            <div id="agreement"></div>
        </div>
        <div id="peace_content" class="third">
            <h5 style="margin-left: 10px;">Description: </h5>
            <p id="peace"></p>
            <p id="peace">View agreement: <a id="linkie" target="_blank" href="https://dennikn.sk/"><img
                        src="img/agt_icon.svg" alt="HTML tutorial" style="height:20px;"></a></p>
        </div>
        <div id="timeline" class="third">
            <h5 id="time_title" style="margin-left: 10px;">Timelines: </h5>
        </div>
    </div>

    <div id="net-legend" class="legend">
        <h4 id="filter_title">Filter by Stages</h4>
        <div id="one"><span style="background-color: #fbb03b; cursor: pointer;"></span>Pre-negotiation</div>
        <div id="two"><span style="background-color: #223b53; cursor: pointer;"></span>Renewal</div>
        <div id="three"><span style="background-color: #e55e5e; cursor: pointer;"></span>Ceasefire</div>
        <div id="four"><span style="background-color: #3bb2d0; cursor: pointer;"></span>Framework-substantive, partial
        </div>
        <div id="five"><span style="background-color: steelblue; cursor: pointer;"></span>Implementation</div>
        <div id="six"><span style="background-color: white; cursor: pointer;"></span>Other</div>
    </div>

    <script>
        //adapt to screen
        let screen_height = window.innerHeight;
        let screen_width = window.innerWidth;
        let details_height = screen_height - 50;

        const margin = { top: 20, right: 20, bottom: 35, left: 25 },
            width = screen_width * 0.28 - margin.left - margin.right,
            height = details_height / 3 - margin.top - margin.bottom,
            the_height = height - 20

        // append the svg object to the body of the page
        const svg = d3.select("#timeline")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", the_height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        svg.append("g")
            .attr("class", "myXaxis")
        svg.append("g")
            .attr("class", "myYaxis")

        const x_scale = d3.scaleTime()
            .range([0, width])

        const y = d3.scaleLinear()
            .domain([0, 5])
            .range([the_height, 0]);

        d3.selectAll("#peace_process, #info")
            .style("height", details_height + "px")
            .style("width", screen_width * 0.28 + "px")
            .style("right", - screen_width * 0.30 + "px")
        d3.selectAll(".third")
            .style("height", (details_height - 16) / 3 + "px")
        // info button
        let counter_collab = 0;
        d3.select("#info_button").on("click", function () {
            counter_collab += 1;
            d3.selectAll("#peace_process")
                .transition().duration(800)
                .style("right", - screen_width * 0.30 + "px")
            if (counter_collab % 2 !== 0) {
                d3.select("#info")
                    .transition().duration(500)
                    .style("right", 0 + "px")
            }
            else {
                d3.select("#info")
                    .transition().duration(500)
                    .style("right", - screen_width * 0.30 + "px")
            }
        })
        // load mapbox
        mapboxgl.accessToken = 'pk.eyJ1Ijoic2FzaGFnYXJpYmFsZHkiLCJhIjoiY2xyajRlczBlMDhqMTJpcXF3dHJhdTVsNyJ9.P_6mX_qbcbxLDS1o_SxpFg';
        const map = new mapboxgl.Map({
            container: 'map',
            // style: 'mapbox://styles/mapbox/dark-v11',
            style: 'mapbox://styles/sashagaribaldy/cls4l3gpq003k01r0fc2s04tv',
            center: [40.137343, 30.137451],
            zoom: 3,
            attributionControl: false
        });

        // load the data
        Promise.all([
            d3.csv("data/local.csv"),
            d3.csv("data/loc_correction.csv"),
            d3.csv("data/pax.csv"),
        ]).then(function (files) {
            //clean location names and add description
            let raw_data = files[0]
            let parseDate = d3.timeParse("%d-%m-%Y");
            raw_data.forEach(function (o) {
                o.Dat = o.Dat.replace(/\//g, '-')
                o.Dat = parseDate(o.Dat)
            })

            function find_id(curr_id) {
                let the_country = files[1].find(function (x) {
                    return x.AgtId == curr_id
                })
                let the_category = files[2].find(function (x) {
                    return x.AgtId == curr_id
                })
                return [the_country.country_entity, the_category]
            }
            raw_data.forEach(function (d) {
                let curr_id = d.AgtId;
                let the_country = find_id(curr_id)
                d.Con = the_country[0];
                d.stage = the_country[1].stage_label;
                d.description = the_country[1].description;
                d.agreement = the_country[1].Agt;
                d.linkie = the_country[1].PAX_Generate_PDF
            })
            //construct unique country array
            let country_array = []
            raw_data.forEach((d) => {
                if (country_array.includes(d.Con) == false) {
                    country_array.push(d.Con)
                }
            })
            // creating conflict geojson
            let local_conflict_geojson = []
            raw_data.forEach(function (d) {
                let to_push = {
                    'type': 'Feature',
                    'properties': {
                        'id': d.AgtId,
                        'p_process': d.PPName,
                        'text': d.LocaleName,
                        'stage': d.stage,
                        'description': d.description,
                        'agreement': d.agreement,
                        'link': d.linkie
                    },
                    'geometry': {
                        'type': 'Point',
                        'coordinates': [d.LongDec, d.LatDec]
                    }
                }
                local_conflict_geojson.push(to_push)
            })
            const thaa = {
                'type': 'FeatureCollection',
                'features': local_conflict_geojson
            };
            let hoveredPolygonId = null;
            //draw polygons
            map.on('load', () => {
                // Add a data source containing GeoJSON data.
                map.addSource('states', {
                    'type': 'geojson',
                    'data': thaa,
                    'generateId': true //This ensures that all features have unique IDs
                });
                //circles for agreements
                map.addLayer(
                    {
                        'id': 'population',
                        'type': 'circle',
                        'source': 'states',
                        'paint': {
                            // Make circles larger as the user zooms from z12 to z22.
                            // 'circle-radius': {
                            //     'base': 1.75,
                            //     'stops': [
                            //         [12, 5],
                            //         [22, 180]
                            //     ]
                            // },
                            "circle-opacity": 0.7,
                            "circle-stroke-width": 0.5,
                            'circle-radius': [
                                'case',
                                ['boolean', ['feature-state', 'hover'], false],
                                10,
                                7
                            ],


                            "circle-stroke-color": '#000',
                            'circle-color':
                                [
                                    'match',
                                    ['get', 'stage'],
                                    'Pre-negotiation',
                                    '#fbb03b',
                                    'Renewal',
                                    '#223b53',
                                    'Ceasefire',
                                    '#e55e5e',
                                    'Framework-substantive, partial',
                                    '#3bb2d0',
                                    'Implementation',
                                    'steelblue',
                                    'Other',
                                    'white',
                                    'white'
                                ]
                        }
                    },
                    // Place polygons under labels, roads and buildings.
                    // 'aeroway-polygon'
                );

                map.on('click', 'population', (e, i) => {
                    map.flyTo({ center: [e.lngLat.lng, e.lngLat.lat], zoom: 6 });
                    const description = e.features[0].properties
                    d3.select("#peace_process")
                        .transition().duration(800)
                        .style("right", 3 + "px")
                    d3.select("#info")
                        .transition().duration(500)
                        .style("right", - screen_width * 0.30 + "px")
                    counter_collab = 0;

                    d3.select("#peace_title")
                        .html(description.p_process)
                    d3.select("#process_stage")
                        .html(`<h5>Stage of Process: </h5>` + `<p>` + description.stage + `</p>`)
                    d3.select("#agreement")
                        .html(`<h5>Agreement: </h5>` + `<p>` + description.agreement + `</p>`)
                    d3.select("#peace")
                        .html(description.description)
                    $("#linkie").attr('href', description.link);

                    //timeline
                    let peace_instance = d3.groups(raw_data, function (r) {
                        return r.PPName == description.p_process
                    })
                    let peace_data = peace_instance[1][1];
                    function sortByDateAscending(a, b) {
                        return a.Dat - b.Dat;
                    }
                    let the_data = peace_data.sort(sortByDateAscending);
                    let almost_final = d3.groups(the_data, function (r) {
                        return r.Dat
                    })
                    let first_year = almost_final[0][0]
                    let last_year = almost_final[almost_final.length - 1][0]
                    x_scale.domain([first_year, last_year])

                    svg.selectAll(".myXaxis").transition().duration(500)
                        .attr("transform", "translate(0," + the_height + ")")
                        .call(d3.axisBottom(x_scale).tickFormat(d3.timeFormat("%Y")).ticks(5))
                        .selectAll("text")
                        .style("font-family", "Montserrat")
                        // .attr("transform", "translate(-10,0)rotate(-45)")
                        .style("text-anchor", "middle");

                    svg.selectAll(".myYaxis")
                        .call(d3.axisLeft(y).tickSize(-width).ticks(3))
                        .style("stroke-dasharray", "10, 5")
                        .selectAll("text")
                        .style("font-family", "Montserrat")

                    console.log(almost_final);

                    svg.selectAll(".mybar")
                        .data(almost_final, d => d)
                        .join(
                            enter => enter.append("rect")
                                .attr("class", "mybar")
                                .attr("x", d => x_scale(d[0]))
                                .attr("y", the_height)
                                .attr("rx", 3)
                                .attr("height", 0)
                                .attr("width", 1)
                                .attr("fill", "white")
                                .transition().duration(1000)
                                .attr("y", function (d) {
                                    return y(d[1].length)
                                })
                                .attr("height", d => the_height - y(d[1].length))
                                .selection(),
                            update => update
                                .transition().duration(1000)
                                .attr("x", d => x_scale(d[0]))
                                .attr("y", function (d) {
                                    return y(d[1].length)
                                })
                                .attr("width", 1)
                                .attr("height", d => the_height - y(d[1].length))
                                .selection(),
                            exit => exit
                                .transition().duration(500)
                                .attr("y", the_height)
                                .attr("height", 0)
                                .remove()
                        )

                    d3.selectAll(".domain")
                        .attr("visibility", "hidden")
                })

                d3.select("#one").on("click", function (d) {
                    map.setFilter('population', ['==', 'stage', 'Pre-negotiation']);
                })
                d3.select("#two").on("click", function (d) {
                    map.setFilter('population', ['==', 'stage', 'Renewal']);
                })
                d3.select("#three").on("click", function (d) {
                    map.setFilter('population', ['==', 'stage', 'Ceasefire']);
                })
                d3.select("#four").on("click", function (d) {
                    map.setFilter('population', ['==', 'stage', 'Framework-substantive, partial']);
                })
                d3.select("#five").on("click", function (d) {
                    map.setFilter('population', ['==', 'stage', 'Implementation']);
                })
                d3.select("#six").on("click", function (d) {
                    map.setFilter('population', ['==', 'stage', 'Other']);
                })

                map.on('mouseenter', 'population', (e) => {
                    map.getCanvas().style.cursor = 'pointer';
                    const description = e.features[0].properties
                    if (e.features.length > 0) {
                        if (hoveredPolygonId !== null) {
                            map.setFeatureState(
                                { source: 'states', id: hoveredPolygonId },
                                { hover: false }
                            );
                            map.setFeatureState(
                                { source: 'states', id: hoveredPolygonId },
                                { hover: false }
                            );
                        }
                        hoveredPolygonId = e.features[0].id;
                        map.setFeatureState(
                            { source: 'states', id: hoveredPolygonId },
                            { hover: true }
                        );
                    }

                    d3.select("#description")
                        .style("display", "block")
                        .style("left", e.point.x + 30 + "px")
                        .style("top", e.point.y - 25 + "px")
                        .html(description.agreement)
                });

                // Change it back to a pointer when it leaves.
                map.on('mouseleave', 'population', () => {
                    map.getCanvas().style.cursor = '';
                    if (hoveredPolygonId !== null) {
                        map.setFeatureState(
                            { source: 'states', id: hoveredPolygonId },
                            { hover: false }
                        );
                    }
                    hoveredPolygonId = null;
                    d3.select("#description")
                        .style("display", "none")
                });

                // refresh everything
                d3.select("#refresh_button").on("click", function (m) {
                    map.flyTo({ center: [40.137343, 30.137451], zoom: 3 });
                    // d3.select("#big_title").text("Conflict and Peace Process Map")
                    d3.selectAll("#peace_process, #info")
                        .transition().duration(800)
                        .style("right", - screen_width * 0.30 + "px")
                    counter_collab = 0;
                    map.setFilter('population', null)
                })

                // map.addSource('states', {
                //     'type': 'geojson',
                //     'data': geo_data,
                //     'generateId': true //This ensures that all features have unique IDs
                // });
                // Add a new layer to visualize the polygon.
                // map.addLayer({
                //     'id': 'state-fills',
                //     'type': 'fill',
                //     'source': 'states',
                //     'layout': {},
                //     'paint': {
                //         'fill-color': '#006297',
                //         'fill-opacity': 0.5
                //     },
                //     'filter': ['in', 'ADMIN', ...country_array]

                // });
                // map.addLayer({
                //     'id': 'outline',
                //     'type': 'line',
                //     'source': 'states',
                //     'layout': {},
                //     'paint': {
                //         'line-color': 'black',
                //         'line-width': [
                //             'case',
                //             ['boolean', ['feature-state', 'hover'], false],
                //             2,
                //             0.5
                //         ],
                //     }
                // });

                // for (const marker of raw_data) {
                //     if (marker.LongDec !== "999") {
                //         let coord = [marker.LongDec, marker.LatDec]
                //         const el = document.createElement('div');
                //         const width = 10;
                //         const height = 10;
                //         el.className = 'marker';
                //         el.style.backgroundImage = `url(img/circle.png)`;
                //         el.style.width = `${width}px`;
                //         el.style.height = `${height}px`;
                //         el.style.backgroundSize = '100%';
                //         el.style.cursor = "pointer"

                //         new mapboxgl.Marker(el)
                //             .setLngLat(coord)
                //             .addTo(map);
                //     }
                // }

            })


        });
    </script>
</body>

</html>